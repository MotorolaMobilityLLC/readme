# MMI-UHAS34.29-3 For moto penang 4G 4G+

my_top_dir=$PWD

KERNEL_DIR=$my_top_dir/kernel-5.10

REL_KERNEL_OUT="$my_top_dir/out/target/product/penangf/obj/KERNEL_OBJ"

kernel_out_dir="$my_top_dir/out/target/product/penangf/obj/KERNEL_OBJ/kernel-5.10"

MODULES_STAGING_DIR=$my_top_dir/out/target/product/penangf/obj/KERNEL_OBJ/staging

KERNEL_ZIMAGE_OUT="$kernel_out_dir/arch/arm64/boot/Image.gz"

TARGET_KERNEL_CONFIG="$kernel_out_dir/.config"

KERNEL_DLKM="$my_top_dir/vendor/mediatek/kernel_modules"


#google tools
mkdir -vp  $my_top_dir/prebuilts/clang/host
cd $my_top_dir/prebuilts/clang/host
git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 -b aml_tz3_314012010
cd $my_top_dir
cd $my_top_dir/prebuilts
git clone https://android.googlesource.com/kernel/prebuilts/build-tools
cd $my_top_dir

#kernel code
mkdir -vp $my_top_dir/kernel-5.10
cd $my_top_dir/kernel-5.10
git clone https://github.com/MotorolaMobilityLLC/kernel-mtk.git
cd kernel-mtk
git checkout android-14-release-uhas34.29
cd ../
#cp -rf kernel-mtk kernel-5.10
mv kernel-mtk/* ./
cd $my_top_dir

#kernel/prebuilts tools
mkdir -vp $my_top_dir/kernel/prebuilts/
cd $my_top_dir/kernel/prebuilts/
git clone https://github.com/MotorolaMobilityLLC/kernel-prebuilts-kernel-build-tools.git
cd kernel-prebuilts-kernel-build-tools
git checkout android-14-release-uhas34.29
cd ../
cp -rf kernel-prebuilts-kernel-build-tools/ kernel-build-tools/
cd $my_top_dir

#kernel_dlkm-1
mkdir -vp $KERNEL_DLKM
cd $KERNEL_DLKM

git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-gpu.git
cd vendor-mediatek-kernel_modules-gpu
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-gpu/ gpu/
cd $KERNEL_DLKM

#kernel_dlkm-2
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-met_drv_v3.git
cd vendor-mediatek-kernel_modules-met_drv_v3
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-met_drv_v3/ met_drv_v3/
cd $KERNEL_DLKM

#kernel_dlkm-3
mkdir -vp connectivity
cd connectivity
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-gps.git
cd vendor-mediatek-kernel_modules-connectivity-gps
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-gps/ gps/
cd $KERNEL_DLKM

#kernel_dlkm-4
mkdir -vp connectivity
cd connectivity
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-common.git
cd vendor-mediatek-kernel_modules-connectivity-common
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-common/ common/
cd $KERNEL_DLKM

#kernel_dlkm-5
mkdir -vp connectivity
cd connectivity
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-fmradio.git
cd vendor-mediatek-kernel_modules-connectivity-fmradio
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-fmradio/ fmradio/
cd $KERNEL_DLKM

#kernel_dlkm-6
mkdir -vp connectivity
cd connectivity
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-connfem.git
cd vendor-mediatek-kernel_modules-connectivity-connfem
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-connfem/ connfem/
cd $KERNEL_DLKM

#kernel_dlkm-7
mkdir -vp connectivity/wlan
cd connectivity/wlan
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-wlan-adaptor.git
cd vendor-mediatek-kernel_modules-connectivity-wlan-adaptor
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-wlan-adaptor/ adaptor/
cd $KERNEL_DLKM

#kernel_dlkm-8
mkdir -vp connectivity/wlan/core
cd connectivity/wlan/core
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-wlan-core-gen4m.git
cd vendor-mediatek-kernel_modules-connectivity-wlan-core-gen4m
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-wlan-core-gen4m/ gen4m/
cd $KERNEL_DLKM

#kernel_dlkm-9
mkdir -vp connectivity/bt
cd connectivity/bt
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-connectivity-bt-mt66xx.git
cd vendor-mediatek-kernel_modules-connectivity-bt-mt66xx
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-connectivity-bt-mt66xx/ mt66xx/
cd $KERNEL_DLKM

#kernel_dlkm-10
git clone https://github.com/MotorolaMobilityLLC/vendor-mediatek-kernel_modules-udc.git
cd vendor-mediatek-kernel_modules-udc
git checkout android-14-release-uhas34.29
cd ../
cp -rf vendor-mediatek-kernel_modules-udc/ udc/
cd $KERNEL_DLKM

cd $my_top_dir

PATH=$my_top_dir/prebuilts/build-tools/path/linux-x86:$my_top_dir/prebuilts/clang/host/linux-x86/clang-r416183b/bin:$my_top_dir/kernel/prebuilts/kernel-build-tools/linux-x86/bin:$PATH

DTC_PATH=$my_top_dir/prebuilts/build-tools/linux-x86/bin/dtc

#export CLANG_TRIPLE= CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CROSS_COMPILE_ARM32= ARCH=arm64 SUBARCH= MAKE_GOALS=all HOSTCC=clang HOSTCXX=clang++ CC=clang LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump READELF=llvm-readelf OBJSIZE=llvm-size STRIP=llvm-strip
export CLANG_TRIPLE= CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_COMPAT=arm-linux-gnueabi- CROSS_COMPILE_ARM32= ARCH=arm64 SUBARCH= MAKE_GOALS=all HOSTCC=clang HOSTCXX=clang++ CC=clang LD=ld.lld NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump OBJSIZE=llvm-size STRIP=llvm-strip

mkdir -vp $kernel_out_dir

cd $my_top_dir

python kernel-5.10/scripts/gen_build_config.py --kernel-defconfig penangf_defconfig --kernel-defconfig-overlays "" --kernel-build-config-overlays "" -m user -o $REL_KERNEL_OUT/build.config

cp -p kernel-5.10/arch/arm64/configs/penangf_defconfig $REL_KERNEL_OUT/penangf.config

cd kernel-5.10 

make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH O=$kernel_out_dir gki_defconfig ../../../../out/target/product/penangf/obj/KERNEL_OBJ/penangf.config 
# /penang4gu-kernel/Kernel/kernel-5.10/arch/arm64/configs/../../../../kernel/../out/target/product/penangf/obj/KERNEL_OBJ/penangf.config

cd $kernel_out_dir

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH all vmlinux

make -j16 O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

# DLKM driver
# -------------------
# OUT_DIR=/out/target/product/penangf/obj/KERNEL_OBJ/kernel-5.10
# EXT_MOD_REL=vendor/mediatek/kernel_modules/fpsgo_cus
# mkdir -p ${OUT_DIR}/${EXT_MOD_REL}
#############################################################
cd -

mkdir -p $REL_KERNEL_OUT/vendor/mediatek/kernel_modules/met_drv_v3

make -C ../vendor/mediatek/kernel_modules/met_drv_v3 M=../vendor/mediatek/kernel_modules/met_drv_v3 KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH

make -C ../vendor/mediatek/kernel_modules/met_drv_v3 M=../vendor/mediatek/kernel_modules/met_drv_v3 KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

mkdir -p $REL_KERNEL_OUT/vendor/mediatek/kernel_modules/gpu/platform/mt6768

make -C ../vendor/mediatek/kernel_modules/gpu/platform/mt6768 M=../vendor/mediatek/kernel_modules/gpu/platform/mt6768 KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH

make -C ../vendor/mediatek/kernel_modules/gpu/platform/mt6768 M=../vendor/mediatek/kernel_modules/gpu/platform/mt6768 KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

mkdir -p $REL_KERNEL_OUT/vendor/mediatek/kernel_modules/connectivity/common

make -C ../vendor/mediatek/kernel_modules/connectivity/common M=../vendor/mediatek/kernel_modules/connectivity/common KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH

make -C ../vendor/mediatek/kernel_modules/connectivity/common M=../vendor/mediatek/kernel_modules/connectivity/common KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

mkdir -p $REL_KERNEL_OUT/vendor/mediatek/kernel_modules/connectivity/fmradio

make -C ../vendor/mediatek/kernel_modules/connectivity/fmradio M=../vendor/mediatek/kernel_modules/connectivity/fmradio KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH

make -C ../vendor/mediatek/kernel_modules/connectivity/fmradio M=../vendor/mediatek/kernel_modules/connectivity/fmradio KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

mkdir -p $REL_KERNEL_OUT/vendor/mediatek/kernel_modules/connectivity/common

make -C ../vendor/mediatek/kernel_modules/connectivity/common M=../vendor/mediatek/kernel_modules/connectivity/common KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH

make -C ../vendor/mediatek/kernel_modules/connectivity/common M=../vendor/mediatek/kernel_modules/connectivity/common KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

mkdir -p $REL_KERNEL_OUT/vendor/mediatek/kernel_modules/connectivity/gps/gps_stp

make -C ../vendor/mediatek/kernel_modules/connectivity/gps/gps_stp M=../vendor/mediatek/kernel_modules/connectivity/gps/gps_stp KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH

make -C ../vendor/mediatek/kernel_modules/connectivity/gps/gps_stp M=../vendor/mediatek/kernel_modules/connectivity/gps/gps_stp KERNEL_SRC=$KERNEL_DIR O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH  INSTALL_MOD_PATH=$MODULES_STAGING_DIR  modules_install

cd $kernel_out_dir

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH M=../../ETC/udc_lib.ko_intermediates/LINKED AUTOCONF_H=$kernel_out_dir/include/generated/autoconf.h src=$my_top_dir/vendor/mediatek/kernel_modules/udc

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH M=../../ETC/connfem.ko_intermediates/LINKED AUTOCONF_H=$kernel_out_dir/include/generated/autoconf.h src=../vendor/mediatek/kernel_modules/connectivity/connfem

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH M=../../ETC/wmt_drv.ko_intermediates/LINKED AUTOCONF_H=$kernel_out_dir/include/generated/autoconf.h MTK_CONSYS_ADIE= MTK_PLATFORM_WMT=MT6768 TARGET_BOARD_PLATFORM_WMT=mt6768 src=$my_top_dir/vendor/mediatek/kernel_modules/connectivity/common

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH M=../../ETC/bt_drv_connac1x.ko_intermediates/LINKED AUTOCONF_H=$kernel_out_dir/include/generated/autoconf.h KBUILD_EXTRA_SYMBOLS=../../ETC/wmt_drv.ko_intermediates/LINKED/Module.symvers BT_PLATFORM=connac1x 'LOG_TAG=[BT_Drv][wmt]' BT_ENABLE_LOW_POWER_DEBUG=y src=$my_top_dir/vendor/mediatek/kernel_modules/connectivity/bt/mt66xx/wmt

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH M=../../ETC/wmt_chrdev_wifi.ko_intermediates/LINKED AUTOCONF_H=$kernel_out_dir/include/generated/autoconf.h KBUILD_EXTRA_SYMBOLS=../../ETC/wmt_drv.ko_intermediates/LINKED/Module.symvers CONNAC_VER=1_0 MODULE_NAME=wmt_chrdev_wifi src=$my_top_dir/vendor/mediatek/kernel_modules/connectivity/wlan/adaptor

make O=$kernel_out_dir LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=$DTC_PATH M=../../ETC/wlan_drv_gen4m.ko_intermediates/LINKED AUTOCONF_H=$kernel_out_dir/include/generated/autoconf.h 'KBUILD_EXTRA_SYMBOLS=../../ETC/wmt_chrdev_wifi.ko_intermediates/LINKED/Module.symvers ../../ETC/wmt_drv.ko_intermediates/LINKED/Module.symvers ../../ETC/connfem.ko_intermediates/LINKED/Module.symvers' CONFIG_MTK_COMBO_WIFI_HIF=axi MODULE_NAME=wlan_drv_gen4m MTK_COMBO_CHIP=CONNAC WLAN_CHIP_ID=6768 MTK_ANDROID_WMT=y WIFI_ENABLE_GCOV= WIFI_IP_SET=1 MTK_ANDROID_EMI=y MTK_WLAN_SERVICE=yes src=$my_top_dir/vendor/mediatek/kernel_modules/connectivity/wlan/core/gen4m
